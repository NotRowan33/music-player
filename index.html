<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>
    <!-- Spotify Web Playback SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Scrollbar styles for a more modern look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #191414;
        }
        ::-webkit-scrollbar-thumb {
            background: #4d4d4d;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-[#121212] text-white overflow-hidden">
    <div id="app-container" class="relative flex h-screen">

        <!-- Sidebar Navigation -->
        <aside class="hidden md:flex flex-col space-y-4 p-6 bg-black w-64">
            <div class="flex items-center space-x-2">
                 <svg role="img" height="32" width="32" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" class="text-[#1DB954]"><path d="M8 1.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"></path><path d="M11.562 6.125a.75.75 0 0 1 .028 1.06l-3.376 3.375a.75.75 0 0 1-1.062 0l-1.59-1.59a.75.75 0 1 1 1.06-1.06l1.06 1.06 2.848-2.848a.75.75 0 0 1 1.032-.028z"></path></svg>
                <h1 class="text-2xl font-bold">MusicApp</h1>
            </div>
            <nav>
                <ul>
                    <li>
                        <a href="#" class="flex items-center space-x-4 p-2 rounded-md hover:bg-zinc-800 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                            <span>Home</span>
                        </a>
                    </li>
                     <li>
                        <a href="#" class="flex items-center space-x-4 p-2 rounded-md bg-zinc-800">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                            <span>Search</span>
                        </a>
                    </li>
                     <li>
                        <a href="#" class="flex items-center space-x-4 p-2 rounded-md hover:bg-zinc-800 transition-colors duration-200">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect width="8" height="4" x="8" y="2" rx="1"/><path d="M8 22v-7.5a3.5 3.5 0 0 1 7 0V22"/><path d="M12 12v2"/></svg>
                            <span>Your Library</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-gradient-to-b from-[#222] to-[#121212]">
            <header class="sticky top-0 z-10 p-4 md:p-6 bg-[#121212]/80 backdrop-blur-sm">
                <div class="flex justify-between items-center">
                    <div class="relative w-full max-w-sm">
                        <input id="search-input" type="text" placeholder="Search for songs or artists..." class="w-full bg-zinc-800 border border-zinc-700 rounded-full px-5 py-3 text-white placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-green-500" disabled>
                        <svg class="absolute right-4 top-1/2 -translate-y-1/2 h-5 w-5 text-zinc-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    </div>
                    <div id="auth-container">
                         <button id="login-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full transition-transform duration-200 hover:scale-105">
                            Login with Spotify
                        </button>
                    </div>
                </div>
            </header>
            
            <div id="content-display" class="p-4 md:p-6">
                <div id="initial-message" class="flex flex-col items-center justify-center text-center text-zinc-400 h-full mt-20">
                     <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                    <h2 id="initial-title" class="text-3xl font-bold text-white mt-4">Login to start listening</h2>
                    <p id="initial-subtitle" class="mt-2">Use the button in the top right to connect your Spotify account.</p>
                </div>
                <div id="search-results" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6 hidden"></div>
                <div id="loading-spinner" class="text-center mt-20 hidden">
                    <svg class="animate-spin h-10 w-10 text-green-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </div>
            </div>
        </main>
        
         <!-- Client ID Modal -->
        <div id="client-id-modal" class="fixed inset-0 z-50 bg-black bg-opacity-80 flex items-center justify-center p-4">
            <div class="bg-zinc-900 rounded-lg shadow-xl p-8 max-w-lg w-full">
                <h2 class="text-2xl font-bold mb-2 text-center">Spotify Client ID Required</h2>
                <p class="text-zinc-400 mb-6 text-center text-sm">Please enter your Client ID from the Spotify Developer Dashboard. You also need to add your current URL as a Redirect URI in your Spotify app settings.</p>
                <div class="space-y-4">
                    <input id="client-id-input" class="w-full bg-zinc-800 border border-zinc-700 rounded-md p-3 text-sm text-zinc-300 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Enter your Spotify Client ID">
                </div>
                <button id="save-client-id-button" class="mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full transition-transform duration-200 hover:scale-105 w-full">
                    Configure & Start
                </button>
            </div>
        </div>
    </div>
    
    <!-- Now Playing Bar -->
    <footer id="player-bar" class="fixed bottom-0 left-0 right-0 h-24 bg-[#181818] border-t border-zinc-800 flex items-center justify-between px-4 md:px-6">
        <div class="flex items-center space-x-4 w-1/3 min-w-0">
            <img id="now-playing-artwork" src="https://placehold.co/64x64/000000/1DB954?text=Music" alt="Album Art" class="w-16 h-16 rounded-md bg-zinc-800">
            <div class="min-w-0">
                <p id="now-playing-title" class="font-semibold truncate">Select a song</p>
                <p id="now-playing-artist" class="text-sm text-zinc-400 truncate">No artist</p>
            </div>
        </div>
        <div class="flex flex-col items-center space-y-2 w-1/3">
             <div class="flex items-center space-x-6">
                 <button id="previous-button" class="text-zinc-400 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"><svg role="img" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" class="w-5 h-5"><path d="M3.3 1a.7.7 0 0 1 .7.7v5.15l9.95-5.744a.7.7 0 0 1 1.05.606v12.575a.7.7 0 0 1-1.05.607L4 8.45V14.3a.7.7 0 0 1-1.4 0V1.7a.7.7 0 0 1 .7-.7z"></path></svg></button>
                <button id="play-pause-button" class="bg-white text-black rounded-full p-3 transition-transform duration-200 hover:scale-110 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100" disabled>
                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="translate-x-px"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="hidden"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                 <button id="next-button" class="text-zinc-400 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"><svg role="img" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor" class="w-5 h-5"><path d="M12.7 1a.7.7 0 0 0-.7.7v5.15L2.05 1.107A.7.7 0 0 0 1 1.712v12.575a.7.7 0 0 0 1.05.607L12 8.45V14.3a.7.7 0 0 0 1.4 0V1.7a.7.7 0 0 0-.7-.7z"></path></svg></button>
            </div>
             <div class="flex items-center space-x-2 w-full max-w-sm">
                <span id="current-time" class="text-xs text-zinc-400 w-10 text-right">0:00</span>
                <div id="progress-container" class="w-full h-1 bg-zinc-600 rounded-full cursor-pointer group">
                    <div id="progress-bar" class="h-full bg-white w-0 rounded-full group-hover:bg-green-500"></div>
                </div>
                <span id="duration" class="text-xs text-zinc-400 w-10">0:00</span>
            </div>
        </div>
        <div class="w-1/3"></div>
    </footer>

    <script type="module">
        // --- DOM Elements ---
        const clientIdModal = document.getElementById('client-id-modal');
        const clientIdInput = document.getElementById('client-id-input');
        const saveClientIdButton = document.getElementById('save-client-id-button');
        const authContainer = document.getElementById('auth-container');
        const loginButton = document.getElementById('login-button');
        const searchInput = document.getElementById('search-input');
        const searchResultsContainer = document.getElementById('search-results');
        const initialMessage = document.getElementById('initial-message');
        const initialTitle = document.getElementById('initial-title');
        const initialSubtitle = document.getElementById('initial-subtitle');
        const loadingSpinner = document.getElementById('loading-spinner');
        const playPauseButton = document.getElementById('play-pause-button');
        const nextButton = document.getElementById('next-button');
        const previousButton = document.getElementById('previous-button');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const nowPlayingArtwork = document.getElementById('now-playing-artwork');
        const nowPlayingTitle = document.getElementById('now-playing-title');
        const nowPlayingArtist = document.getElementById('now-playing-artist');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');

        // --- App State ---
        let spotifyPlayer;
        let deviceId;
        let clientId;
        let accessToken;

        // --- AUTHENTICATION (PKCE FLOW) ---
        
        async function redirectToAuthCodeFlow() {
            const verifier = generateCodeVerifier(128);
            const challenge = await generateCodeChallenge(verifier);
            localStorage.setItem("verifier", verifier);
            const params = new URLSearchParams();
            params.append("client_id", clientId);
            params.append("response_type", "code");
            params.append("redirect_uri", window.location.origin + window.location.pathname);
            params.append("scope", "streaming user-read-email user-read-private user-modify-playback-state user-read-playback-state");
            params.append("code_challenge_method", "S256");
            params.append("code_challenge", challenge);
            document.location = `https://accounts.spotify.com/authorize?${params.toString()}`;
        }

        async function getAccessToken(code) {
            const verifier = localStorage.getItem("verifier");
            const params = new URLSearchParams();
            params.append("client_id", clientId);
            params.append("grant_type", "authorization_code");
            params.append("code", code);
            params.append("redirect_uri", window.location.origin + window.location.pathname);
            params.append("code_verifier", verifier);

            const result = await fetch("https://accounts.spotify.com/api/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: params
            });
            const { access_token } = await result.json();
            return access_token;
        }

        function generateCodeVerifier(length) {
            let text = '';
            let possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        async function generateCodeChallenge(codeVerifier) {
            const data = new TextEncoder().encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        // --- SPOTIFY WEB PLAYBACK SDK ---

        window.onSpotifyWebPlaybackSDKReady = () => {
            if (!accessToken) return;

            spotifyPlayer = new Spotify.Player({
                name: 'Web Music Player',
                getOAuthToken: cb => { cb(accessToken); },
                volume: 0.5
            });

            spotifyPlayer.addListener('ready', ({ device_id }) => {
                console.log('Ready with Device ID', device_id);
                deviceId = device_id;
            });

            spotifyPlayer.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID has gone offline', device_id);
            });
            
            spotifyPlayer.addListener('player_state_changed', (state) => {
                if (!state) return;
                updateUI(state);
            });
            
            spotifyPlayer.addListener('authentication_error', ({ message }) => {
                console.error('Authentication Error:', message);
                alert(`Authentication error: ${message}`);
            });

            spotifyPlayer.addListener('account_error', ({ message }) => {
                console.error('Account Error:', message);
                alert(`This app requires a Spotify Premium account. Error: ${message}`);
            });

            spotifyPlayer.connect().then(success => {
                if (success) {
                    console.log('The Web Playback SDK successfully connected to Spotify!');
                }
            });
        };
        
        // --- API CALLS ---

        async function fetchProfile() {
            const result = await fetch("https://api.spotify.com/v1/me", {
                method: "GET", headers: { Authorization: `Bearer ${accessToken}` }
            });
            return await result.json();
        }

        async function searchSpotify(term) {
             if (!term) return;
            showLoading(true);
            try {
                const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(term)}&type=track&limit=24`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!response.ok) throw new Error('Spotify search request failed.');
                const data = await response.json();
                displayResults(data.tracks.items);
            } catch (error) {
                console.error("Search failed:", error);
                displayResults([]);
            } finally {
                showLoading(false);
            }
        }
        
        function playTrack(trackUri) {
            if (!deviceId) {
                alert("Playback device is not ready. Please try again in a moment.");
                return;
            }
            fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                method: 'PUT',
                body: JSON.stringify({ uris: [trackUri] }),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
            });
        }

        // --- UI & EVENT HANDLERS ---
        
        function updateUI(state) {
            const track = state.track_window.current_track;
            nowPlayingArtwork.src = track.album.images[0].url;
            nowPlayingTitle.textContent = track.name;
            nowPlayingArtist.textContent = track.artists.map(a => a.name).join(', ');
            
            updatePlayPauseButton(!state.paused);
            playPauseButton.disabled = false;
            nextButton.disabled = state.disallows.skipping_next;
            previousButton.disabled = state.disallows.skipping_prev;
            
            const durationMs = track.duration_ms;
            const positionMs = state.position;
            
            durationEl.textContent = formatTime(durationMs);
            currentTimeEl.textContent = formatTime(positionMs);
            progressBar.style.width = `${(positionMs / durationMs) * 100}%`;
        }
        
        function displayResults(tracks) {
            searchResultsContainer.innerHTML = '';
            if (!tracks || tracks.length === 0) {
                initialMessage.classList.remove('hidden');
                initialTitle.textContent = 'No results found.';
                initialSubtitle.textContent = 'Try a different search term.';
                searchResultsContainer.classList.add('hidden');
                return;
            }
            initialMessage.classList.add('hidden');
            searchResultsContainer.classList.remove('hidden');

            tracks.forEach(track => {
                if (!track.album.images.length) return;
                const artworkURL = track.album.images[0].url;
                const songElement = document.createElement('div');
                songElement.className = 'group bg-zinc-900/50 hover:bg-zinc-800 p-4 rounded-lg transition-all duration-300 cursor-pointer relative';
                songElement.innerHTML = `
                    <div class="relative">
                        <img src="${artworkURL}" alt="${track.name}" class="w-full h-auto rounded-md shadow-lg aspect-square object-cover">
                        <button class="play-song-btn absolute bottom-2 right-2 bg-green-500 text-white rounded-full p-3 shadow-lg opacity-0 group-hover:opacity-100 group-hover:bottom-4 transition-all duration-300 transform hover:scale-110">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="pointer-events-none"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                    </div>
                    <h3 class="font-bold mt-4 truncate">${track.name}</h3>
                    <p class="text-sm text-zinc-400 truncate">${track.artists.map(a => a.name).join(', ')}</p>
                `;
                songElement.querySelector('.play-song-btn').addEventListener('click', () => playTrack(track.uri));
                searchResultsContainer.appendChild(songElement);
            });
        }

        function setupEventListeners() {
            let searchTimeout;
            searchInput.addEventListener('keyup', (event) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => searchSpotify(event.target.value), 300);
            });
            playPauseButton.addEventListener('click', () => spotifyPlayer.togglePlay());
            nextButton.addEventListener('click', () => spotifyPlayer.nextTrack());
            previousButton.addEventListener('click', () => spotifyPlayer.previousTrack());
            
            progressContainer.addEventListener('click', function(e) {
                const rect = this.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const width = rect.width;
                const percentage = x / width;
                const durationMs = spotifyPlayer.state.track_window.current_track.duration_ms;
                spotifyPlayer.seek(durationMs * percentage);
            });
        }
        
        function updatePlayPauseButton(isPlaying) {
            playIcon.classList.toggle('hidden', isPlaying);
            pauseIcon.classList.toggle('hidden', !isPlaying);
        }
        
        function showLoading(isLoading) {
            loadingSpinner.classList.toggle('hidden', !isLoading);
            searchResultsContainer.classList.toggle('hidden', isLoading);
            initialMessage.classList.toggle('hidden', isLoading);
        }
        
        function formatTime(ms) {
            const seconds = Math.floor((ms / 1000) % 60);
            const minutes = Math.floor((ms / (1000 * 60)) % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // --- INITIALIZATION ---
        
        async function initialize() {
            clientId = localStorage.getItem('spotifyClientId');
            if (!clientId) {
                clientIdModal.classList.remove('hidden');
                return;
            }
            clientIdModal.classList.add('hidden');
            
            const params = new URLSearchParams(window.location.search);
            const code = params.get("code");

            if (code) {
                accessToken = await getAccessToken(code);
                window.history.pushState({}, '', window.location.pathname); // Clean URL
            }

            if (accessToken) {
                const profile = await fetchProfile();
                authContainer.innerHTML = `<span class="text-sm">Welcome, ${profile.display_name}</span>`;
                loginButton.style.display = 'none';
                searchInput.disabled = false;
                initialTitle.textContent = 'Start by searching';
                initialSubtitle.textContent = 'Find your favorite songs and artists to start listening.';
                setupEventListeners();
            } else {
                 loginButton.addEventListener('click', redirectToAuthCodeFlow);
            }
        }
        
        saveClientIdButton.addEventListener('click', () => {
            const id = clientIdInput.value.trim();
            if (id) {
                localStorage.setItem('spotifyClientId', id);
                initialize();
            } else {
                alert('Please enter a Client ID.');
            }
        });
        
        initialize();

    </script>
</body>
</html>

